
<!DOCTYPE html>
<html lang="zh-CN" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>乐理学习王 - Music Theory King</title>
    <meta name="description" content="Master music theory with interactive tools." />
    <meta name="theme-color" content="#f97316" />

    <!-- PWA / iOS Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Music Theory">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        tech: ['"Chakra Petch"', 'sans-serif'],
                    },
                    colors: {
                        zinc: {
                            950: '#09090b',
                        }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .selected-note {
            color: #f97316 !important;
            transform: scale(1.1);
            font-weight: 800 !important;
            text-shadow: 0 0 15px rgba(249, 115, 22, 0.2);
        }
        
        .note-name {
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .view-hidden { display: none !important; }

        body, div, span, button, input {
            transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, transform, margin, padding, max-height, box-shadow;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 200ms;
        }

        /* Natural Click Effect */
        .click-flash {
            outline: none !important;
            transition: transform 0.1s ease, opacity 0.2s ease;
        }
        .click-flash:active {
            transform: scale(0.92);
            opacity: 0.7;
        }

        .font-tech-title { font-family: 'Chakra Petch', sans-serif; }

        @keyframes noteFadeIn {
            0% { opacity: 0; transform: translateY(2px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .note-item {
            display: inline-block;
            animation: noteFadeIn 0.2s ease-out forwards;
            margin: 0 1px;
        }

        /* Fixed-height Slot Strategy for Modal Names */
        .modal-name-wrapper {
            height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform: translateY(-5px);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chord-card-active .modal-name-wrapper {
            height: 44px; /* Fixed occupied space for alignment */
            opacity: 1;
            margin-top: 8px;
            margin-bottom: 8px;
            transform: translateY(0);
        }

        .chord-card-active .root-display, 
        .chord-card-active .sec-root-display {
            color: #f97316 !important;
            transform: scale(1.05);
        }

        .content-area {
            padding-bottom: 200px;
        }

        .lang-btn.active {
            background-color: white;
            color: #18181b;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .dark .lang-btn.active {
            background-color: #27272a;
            color: white;
        }

        /* Slide Animation for Card Faces */
        .chord-card-inner {
            display: flex;
            width: 200%;
            height: 100%;
            transform: translateX(-50%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .chord-card-face {
            width: 50%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Center content vertically relative to card center */
            position: relative;
            text-align: center;
            height: 100%; /* Fill the container height */
        }
        .is-secondary .chord-card-inner {
            transform: translateX(0%);
        }

        /* Secondary Face Background Logic (Gray/Zinc Theme) */
        .secondary-face {
            /* 灰色到透明的渐变 */
            background: linear-gradient(to right, #f4f4f5 10%, rgba(255, 255, 255, 0)); 
            transition: background 0.3s ease;
        }
        .dark .secondary-face {
            background: linear-gradient(to right, #27272a 10%, rgba(24, 24, 27, 0));
        }

        /* 当卡片完全翻转（.is-secondary）时，变为均匀的灰色 */
        .group.is-secondary .secondary-face {
            background: #f4f4f5 !important; /* zinc-100 */
        }
        .dark .group.is-secondary .secondary-face {
            background: #27272a !important; /* zinc-800 */
        }
        
        /* Secondary State Visual Enhancement (Gray Border/Shadow) */
        .scale-degree.is-secondary {
            border-color: #a1a1aa !important; /* zinc-400 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dark .scale-degree.is-secondary {
            border-color: #52525b !important; /* zinc-600 */
            box-shadow: none;
        }

        /* 
           Universal Active (Expanded) State 
        */
        .group.chord-card-active {
            z-index: 10; /* Keep z-index to ensure expanded card is on top */
            height: auto !important; /* Force auto height when expanded to fit content */
        }

        .edge-trigger {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.2s;
            color: #a1a1aa; /* zinc-400 for secondary triggers */
            cursor: pointer;
        }
        /* Override primary side trigger color back to orange */
        .edge-left { color: #f97316; }

        /* Desktop arrows behavior */
        @media (hover: hover) {
            .group:hover .edge-trigger { opacity: 0.3; }
            .edge-trigger:hover { opacity: 0.8 !important; }
        }
        
        /* Mobile: hide arrows to rely on swipe */
        @media (hover: none) {
            .edge-trigger { display: none !important; }
        }

        .edge-right { right: 0; }
        .edge-left { left: 0; }

        /* Key Display Animation - Collapsing */
        #current-key-display {
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 24px;
            opacity: 1;
            margin-top: 0.25rem;
            transform: scale(1);
        }
        #current-key-display.hidden-key {
            opacity: 0;
            max-height: 0;
            margin-top: 0;
            transform: scale(0.8);
            pointer-events: none;
        }
        
        /* Refined Toggle Switch */
        .chord-settings {
            background-color: #f4f4f5; /* zinc-100 */
        }
        .dark .chord-settings {
            background-color: #27272a; /* zinc-800 */
        }
        .chord-type-btn {
            color: #71717a; /* zinc-500 */
        }
        .dark .chord-type-btn {
            color: #a1a1aa; /* zinc-400 */
        }
        .chord-type-btn.active-degree {
            background-color: #ffffff;
            color: #18181b; /* zinc-900 */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .dark .chord-type-btn.active-degree {
            background-color: #f4f4f5; /* light white in dark mode */
            color: #09090b; /* zinc-950 */
        }
        
        /* Mode Selector Scroll Container */
        .mode-scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 0.5rem;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: 0.25rem;
            justify-content: center; /* Centered Layout */
        }
        .mode-scroll-container::-webkit-scrollbar { display: none; }

        /* GUITAR FRETBOARD STYLES */
        .guitar-scroll-container {
            /* Hide scrollbar but allow scroll */
            scrollbar-width: none; 
            -ms-overflow-style: none;
            cursor: grab; /* Indicate draggable */
        }
        .guitar-scroll-container:active {
            cursor: grabbing;
        }
        .guitar-scroll-container::-webkit-scrollbar { 
            display: none; 
        }

        .fret-cell {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 2px solid #a1a1aa; /* Fret wire */
            flex-shrink: 0;
            height: 100%;
            cursor: pointer;
        }
        .dark .fret-cell { border-right-color: #52525b; }
        
        /* Nut (Fret 0) styling */
        .fret-0 {
            border-right-width: 6px;
            background-color: #f4f4f5;
            border-right-color: #71717a;
        }
        .dark .fret-0 {
            background-color: #18181b;
            border-right-color: #a1a1aa;
        }

        /* Guitar String Visuals */
        .guitar-string {
            position: absolute;
            left: 0; 
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background-color: #a1a1aa; /* Zinc 400 */
            z-index: 0;
            pointer-events: none; /* Let clicks pass to cell */
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .dark .guitar-string { background-color: #71717a; }

        /* String Gauges (0 is High E, 5 is Low E) */
        .str-0 { height: 1px; }
        .str-1 { height: 1.5px; }
        .str-2 { height: 2px; }
        .str-3 { height: 3px; }
        .str-4 { height: 4px; }
        .str-5 { height: 5px; }

        /* Note Marker */
        .guitar-note-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            animation: popIn 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            user-select: none;
        }

        /* Root: Orange BG, White Text */
        .marker-root {
            background-color: #f97316; 
            color: white;
            box-shadow: 0 2px 4px rgba(249, 115, 22, 0.4);
        }

        /* Chord Tone: White/Dark BG, Orange Text/Border */
        .marker-tone {
            background-color: #ffffff;
            color: #f97316;
            border: 2px solid #f97316;
        }
        .dark .marker-tone {
            background-color: #18181b;
        }
        
        /* Out of key marker (Gray) */
        .marker-gray {
            background-color: #d4d4d8; /* zinc-300 */
            color: white;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .dark .marker-gray {
            background-color: #52525b; /* zinc-600 */
        }

        @keyframes popIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* String Vibration Animation - Updated for ~0.8s duration */
        /* 0.05s * 16 iterations = 0.8s */
        @keyframes vibrate {
            0%, 100% { transform: translateY(-50%); }
            25% { transform: translateY(calc(-50% - 1px)); }
            75% { transform: translateY(calc(-50% + 1px)); }
        }
        .string-vibrating {
            animation: vibrate 0.05s linear 16; 
        }
        
        .fret-number {
            font-size: 10px;
            color: #a1a1aa;
            font-weight: 600;
            margin-top: 4px;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body class="min-h-screen flex flex-col selection:bg-orange-500/20 selection:text-orange-600 text-zinc-900 bg-zinc-50 dark:bg-zinc-950 dark:text-zinc-100 font-sans transition-colors duration-300">

    <div class="app-container min-h-screen border-x flex flex-col bg-white dark:bg-zinc-950 w-full max-w-5xl border-zinc-100 dark:border-zinc-900 mx-auto relative shadow-2xl dark:shadow-none">
        
        <header class="sticky top-0 z-50 bg-white/80 dark:bg-zinc-950/80 backdrop-blur-md border-b border-zinc-100 dark:border-zinc-900 px-4 py-3 sm:px-6 flex justify-between items-center h-16">
            <div class="nav-buttons flex items-center gap-2 shrink-0">
                <button class="nav-btn click-flash group flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100 hover:bg-zinc-100 dark:hover:bg-zinc-900 rounded-full transition-colors" onclick="goToView('home')">
                    <i data-lucide="home" class="w-5 h-5 sm:w-4 sm:h-4"></i>
                    <span class="hidden sm:inline" data-lang-key="home_btn">首页</span>
                </button>
                <button id="back-btn" class="nav-btn click-flash group flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-full transition-colors hidden" onclick="goBack()">
                    <i data-lucide="arrow-left" class="w-5 h-5 sm:w-4 sm:h-4"></i>
                    <span class="hidden sm:inline ml-1" data-lang-key="back_btn">返回</span>
                </button>
            </div>

            <!-- Title Container with Absolute Centering -->
            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center pointer-events-none text-center w-40">
                <h1 class="font-tech-title text-base sm:text-xl font-bold tracking-wide text-zinc-900 dark:text-zinc-100 whitespace-nowrap uppercase leading-none" id="current-page-title" data-lang-key="app_title">乐理学习王</h1>
                <div id="current-key-display" class="hidden-key text-[10px] sm:text-xs font-medium text-orange-500 dark:text-orange-400 tracking-wider uppercase">Key: C</div>
            </div>

            <div class="flex items-center gap-2 shrink-0">
                <div class="hidden sm:flex shrink-0 bg-zinc-100 dark:bg-zinc-900 p-1 rounded-full border border-zinc-200/50 dark:border-zinc-800" id="lang-switcher-desktop">
                    <button class="lang-btn text-xs font-semibold px-2.5 py-1 rounded-full transition-all" data-lang="zh" onclick="setLanguage('zh')">中</button>
                    <button class="lang-btn text-xs font-semibold px-2.5 py-1 rounded-full transition-all" data-lang="en" onclick="setLanguage('en')">En</button>
                    <button class="lang-btn text-xs font-semibold px-2.5 py-1 rounded-full transition-all" data-lang="jp" onclick="setLanguage('jp')">JP</button>
                </div>
                <button id="lang-switcher-mobile" class="sm:hidden w-9 h-9 flex shrink-0 items-center justify-center rounded-full bg-zinc-100 dark:bg-zinc-900 text-zinc-600 dark:text-zinc-400 transition-all text-xs font-bold" onclick="cycleLanguage()">中</button>
                <button class="w-9 h-9 flex items-center justify-center rounded-full bg-zinc-100 dark:bg-zinc-900 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-200 dark:hover:bg-zinc-800 transition-all" onclick="toggleTheme()">
                    <i data-lucide="moon" class="w-4 h-4 hidden dark:block"></i>
                    <i data-lucide="sun" class="w-4 h-4 block dark:hidden"></i>
                </button>
            </div>
        </header>
        
        <div class="content-area flex-grow flex flex-col sm:px-8 w-full max-w-4xl mx-auto pt-4 px-4 items-center justify-start overflow-y-auto">

            <div id="home-view" class="main-menu w-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mt-4">
                <div class="menu-card group relative h-48 sm:h-64 p-8 border border-zinc-200 dark:border-zinc-800 rounded-3xl bg-white dark:bg-zinc-900/50 hover:bg-orange-50/50 dark:hover:bg-zinc-900 cursor-pointer flex flex-col items-center justify-center gap-6 shadow-sm hover:shadow-xl transition-all" onclick="goToView('interval')">
                    <div class="w-16 h-16 rounded-full bg-zinc-50 dark:bg-zinc-800 group-hover:bg-orange-100 dark:group-hover:bg-orange-900/20 flex items-center justify-center text-zinc-400 dark:text-zinc-500 group-hover:text-orange-600 transition-colors">
                        <i data-lucide="music-2" class="w-8 h-8"></i>
                    </div>
                    <span class="text-xl font-bold text-zinc-800 dark:text-zinc-200" data-lang-key="interval_menu">音程关系</span>
                </div>
                <div class="menu-card group h-48 sm:h-64 border border-zinc-200 dark:border-zinc-800 rounded-3xl bg-white dark:bg-zinc-900/50 hover:bg-orange-50/50 dark:hover:bg-zinc-900 cursor-pointer flex flex-col items-center justify-center gap-6 shadow-sm hover:shadow-xl transition-all" onclick="goToView('chord')">
                    <div class="w-16 h-16 rounded-full bg-zinc-50 dark:bg-zinc-800 group-hover:bg-orange-100 dark:group-hover:bg-orange-900/20 flex items-center justify-center text-zinc-400 dark:text-zinc-500 group-hover:text-orange-600 transition-colors">
                        <i data-lucide="layers" class="w-8 h-8"></i>
                    </div>
                    <span class="text-xl font-bold text-zinc-800 dark:text-zinc-200" data-lang-key="chord_menu">和弦组成音</span>
                </div>
                <!-- Guitar Menu Card -->
                <div class="menu-card group h-48 sm:h-64 border border-zinc-200 dark:border-zinc-800 rounded-3xl bg-white dark:bg-zinc-900/50 hover:bg-orange-50/50 dark:hover:bg-zinc-900 cursor-pointer flex flex-col items-center justify-center gap-6 shadow-sm hover:shadow-xl transition-all" onclick="goToView('guitar')">
                    <div class="w-16 h-16 rounded-full bg-zinc-50 dark:bg-zinc-800 group-hover:bg-orange-100 dark:group-hover:bg-orange-900/20 flex items-center justify-center text-zinc-400 dark:text-zinc-500 group-hover:text-orange-600 transition-colors">
                        <i data-lucide="guitar" class="w-8 h-8"></i>
                    </div>
                    <span class="text-xl font-bold text-zinc-800 dark:text-zinc-200" data-lang-key="guitar_menu">虚拟吉他</span>
                </div>
            </div>

            <div id="interval-view" class="view-hidden w-full flex flex-col items-center">
                <div class="interval-result h-32 flex items-center justify-center mb-4 w-full text-center">
                    <span id="actual-interval-display" class="text-[5rem] sm:text-[6rem] font-black text-zinc-900 dark:text-white tracking-tighter"></span>
                </div>
                <div class="note-display w-full flex flex-wrap justify-center gap-4 sm:gap-6 my-4 select-none" id="note-cycle"></div>
                <div class="test-controls w-full flex justify-center gap-4 mt-12 pt-8 border-t border-zinc-100 dark:border-zinc-800">
                    <button class="px-8 py-3 bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 font-bold rounded-full hover:bg-orange-600 transition-all text-sm shadow-lg" onclick="goToView('test')" data-lang-key="test_btn">开始测试</button>
                    <button class="click-flash px-8 py-3 bg-transparent text-zinc-500 dark:text-zinc-400 font-medium hover:text-zinc-900 dark:hover:text-zinc-100 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-all text-sm rounded-full" id="upgrade-btn" onclick="toggleChromatic()" data-lang-key="chromatic_toggle">切换到：带升降音</button>
                </div>
            </div>

            <div id="chord-view" class="view-hidden w-full">
                <div class="chord-header-group flex flex-col items-center gap-2 mb-6 w-full">
                    
                    <!-- Mode Selector (New) -->
                    <div class="relative w-full max-w-2xl px-2">
                         <!-- Gradient fade masks for scrolling -->
                         <div class="absolute left-0 top-0 bottom-0 w-8 bg-gradient-to-r from-white dark:from-zinc-950 to-transparent z-10 pointer-events-none sm:hidden"></div>
                         <div class="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-white dark:from-zinc-950 to-transparent z-10 pointer-events-none sm:hidden"></div>
                         
                         <div class="mode-scroll-container" id="mode-selector">
                            <!-- Buttons rendered via JS -->
                         </div>
                    </div>

                    <div class="chord-settings flex justify-center gap-1 p-1 rounded-full w-fit border border-zinc-200 dark:border-zinc-700 shadow-sm mt-0">
                        <button class="chord-type-btn px-6 py-1.5 rounded-full text-xs font-bold transition-all" data-degree="7" onclick="setChordDegree(7)" data-lang-key="seventh_chord_btn">七和弦</button>
                        <button class="chord-type-btn px-6 py-1.5 rounded-full text-xs font-bold transition-all" data-degree="3" onclick="setChordDegree(3)" data-lang-key="triad_btn">三和弦</button>
                    </div>
                </div>
                <div class="scale-display grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 gap-y-4 gap-x-4 w-full pb-48" id="scale-degrees"></div>
            </div>
            
            <!-- Guitar View -->
            <div id="guitar-view" class="view-hidden w-full flex flex-col items-center justify-start pt-2">
                
                <!-- Guitar Top Bar -->
                <div class="w-full max-w-5xl flex items-center justify-between px-4 mb-2 gap-2 relative h-10">
                    <div class="flex items-center gap-2 z-10">
                         <span class="text-xs font-bold text-zinc-400 uppercase tracking-wider">Key:</span>
                         <input type="text" id="guitar-key-input" value="C" class="w-16 bg-zinc-100 dark:bg-zinc-800 border-none rounded-lg text-center font-bold text-lg text-orange-500 focus:ring-2 focus:ring-orange-500 outline-none p-1 placeholder-zinc-300 uppercase shadow-inner" onchange="updateGuitarKey(this.value)" placeholder="ex: C">
                    
                        <!-- Scale Mode Selector -->
                        <select id="guitar-mode-select" class="bg-zinc-100 dark:bg-zinc-800 text-xs font-bold text-zinc-600 dark:text-zinc-300 rounded-lg p-2 border-none outline-none focus:ring-2 focus:ring-orange-500" onchange="updateGuitarScaleMode(this.value)">
                             <option value="Major">Major</option>
                             <option value="Natural Minor">Natural Minor</option>
                             <option value="Harmonic Minor">Harmonic Minor</option>
                             <option value="Melodic Minor">Melodic Minor</option>
                        </select>
                    </div>

                    <!-- Absolute Center Chord Name -->
                    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-48 text-center pointer-events-none">
                         <div id="guitar-chord-name" class="text-xl font-black text-orange-500 truncate"></div>
                    </div>
                    
                    <button class="z-10 px-4 py-1.5 text-xs font-bold bg-zinc-100 dark:bg-zinc-800 text-zinc-500 rounded-full hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors" onclick="clearGuitarBoard(true)">Clear</button>
                </div>
                
                <!-- Horizontal Scroll Container -->
                <div class="w-full max-w-full overflow-x-auto guitar-scroll-container pb-8 relative">
                    <!-- Fretboard Board -->
                    <div id="fretboard" class="flex flex-col relative bg-zinc-50 dark:bg-zinc-900 border-y-8 border-zinc-300 dark:border-zinc-700 shadow-xl rounded-lg mx-4" style="min-width: max-content;">
                        <!-- JS renders Strings and Frets here -->
                    </div>
                </div>
                
                <p class="mt-4 text-[10px] text-zinc-400 text-center" data-lang-key="guitar_tip">点击指板弹奏音符，长按显示当前调内和弦</p>
            </div>

            <div id="test-view" class="view-hidden w-full max-w-xl mx-auto flex flex-col items-center pt-10">
                <div class="test-question w-full text-center text-2xl sm:text-3xl font-bold text-zinc-800 dark:text-zinc-100 leading-relaxed mb-12" id="test-question-area"></div>
                <div id="feedback-message" class="h-8 text-center font-bold text-sm mb-8 tracking-wide"></div>
                <div class="test-controls w-full flex justify-center gap-4">
                    <button class="px-8 py-4 bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 font-bold rounded-full hover:bg-orange-600 transition-all text-sm shadow-xl" onclick="checkAnswer()" data-lang-key="check_btn">检查答案</button>
                    <button class="px-8 py-4 bg-zinc-100 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-300 font-bold rounded-full hover:bg-zinc-200 transition-all text-sm" onclick="generateTestQuestion()" data-lang-key="next_btn">下一题</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        lucide.createIcons();

        const LANGUAGES = {
            zh: {
                app_title: '乐理学习王', home_btn: '首页', back_btn: '返回',
                interval_menu: '音程关系', chord_menu: '和弦组成音', guitar_menu: '虚拟吉他',
                major_title: '自然大调', natural_minor_title: '自然小调',
                harmonic_minor_title: '和声小调', melodic_minor_title: '旋律小调',
                test_btn: '开始测试', check_btn: '检查答案', next_btn: '下一题',
                chromatic_toggle: '切换到：带升降音', chromatic_toggle_basic: '切换到：基础音名',
                seventh_chord_btn: '七和弦', triad_btn: '三和弦',
                feedback_correct: '正确！', feedback_wrong: '再试一次',
                feedback_reveal: '正确答案是：',
                quiz_prompt: (note, interval) => `从 <b>${note}</b> 开始，<br>${interval} 是哪个音？`,
                guitar_tip: '点击指板弹奏音符，长按显示当前调内和弦'
            },
            en: {
                app_title: 'Theory King', home_btn: 'Home', back_btn: 'Back',
                interval_menu: 'Intervals', chord_menu: 'Chord Tones', guitar_menu: 'Guitar',
                major_title: 'Major', natural_minor_title: 'Natural Minor',
                harmonic_minor_title: 'Harmonic Minor', melodic_minor_title: 'Melodic Minor',
                test_btn: 'Start Test', check_btn: 'Check', next_btn: 'Next',
                chromatic_toggle: 'Mode: Chromatic', chromatic_toggle_basic: 'Mode: Basic',
                seventh_chord_btn: 'Sevenths', triad_btn: 'Triads',
                feedback_correct: 'Correct!', feedback_wrong: 'Try again',
                feedback_reveal: 'The answer is: ',
                quiz_prompt: (note, interval) => `From <b>${note}</b>, <br>what is the ${interval}?`,
                guitar_tip: 'Tap to play. Long press to show chord.'
            },
            jp: {
                app_title: '楽理のキング', home_btn: 'ホーム', back_btn: '戻る',
                interval_menu: '音程', chord_menu: '和音', guitar_menu: 'ギター',
                major_title: 'メジャー', natural_minor_title: '自然短音階',
                harmonic_minor_title: '和声短音階', melodic_minor_title: '旋律短音階',
                test_btn: 'テスト開始', check_btn: '確認', next_btn: '次へ',
                chromatic_toggle: '切替：臨時記号', chromatic_toggle_basic: '切替：基本音名',
                seventh_chord_btn: '七和音', triad_btn: '三和音',
                feedback_correct: '正解！', feedback_wrong: 'もう一度',
                feedback_reveal: '正解は：',
                quiz_prompt: (note, interval) => `<b>${note}</b> から数えて、<br>${interval} はどの音？`,
                guitar_tip: 'タップで演奏、長押しでコード表示'
            }
        };

        const AudioEngine = {
            ctx: null,
            TUNING_FREQ_A4: 440,
            init: function() {
                if (!window.AudioContext && !window.webkitAudioContext) return false;
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
                return true;
            },
            playFreq: function(frequency, startTime, duration = 0.5) {
                if (!this.init()) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(frequency, startTime);
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.2, startTime + 0.03); 
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(startTime);
                osc.stop(startTime + duration);
            },
            playChord: function(rootNote, chordType) {
                if (!this.init()) return;
                let offsets;
                
                // 处理单音模式
                if (chordType === 'note') {
                    offsets = [0];
                } else {
                    offsets = chordOffsetMap[chordType] || [0, 4, 7];
                    if (chordType === '7') offsets = [0, 4, 7, 10];
                }
                
                const rootBase = rootNote.replace(/[0-9]/g, '');
                const rootIndex = noteValueMap[rootBase];
                if (rootIndex === undefined) return;
                const baseOctave = 4; 
                const rootMidi = (baseOctave + 1) * 12 + rootIndex;
                const now = this.ctx.currentTime;
                
                offsets.forEach((offset, index) => {
                    const noteMidi = rootMidi + offset;
                    const frequency = this.TUNING_FREQ_A4 * Math.pow(2, (noteMidi - 69) / 12);
                    // 单音不延迟，和弦琶音
                    const delay = chordType === 'note' ? 0 : (index * 0.08);
                    // 统一时长 0.8s
                    const duration = 0.8;
                    this.playFreq(frequency, now + delay, duration);
                });
            },
            // Guitar Pluck Sound
            playGuitarNote: function(midi, delay = 0) {
                 if (!this.init()) return;
                 const frequency = this.TUNING_FREQ_A4 * Math.pow(2, (midi - 69) / 12);
                 const now = this.ctx.currentTime + delay;
                 
                 const osc = this.ctx.createOscillator();
                 const gain = this.ctx.createGain();
                 
                 // Triangle wave sounds more like a plucked string than sine
                 osc.type = 'triangle'; 
                 osc.frequency.setValueAtTime(frequency, now);
                 
                 // Lowpass filter to dampen the brightness
                 const filter = this.ctx.createBiquadFilter();
                 filter.type = 'lowpass';
                 filter.frequency.setValueAtTime(800 + (midi * 10), now); // Brighter for higher notes

                 gain.gain.setValueAtTime(0, now);
                 gain.gain.linearRampToValueAtTime(0.3, now + 0.02); // Fast attack
                 gain.gain.exponentialRampToValueAtTime(0.001, now + 1.5); // Sustain
                 
                 osc.connect(filter);
                 filter.connect(gain);
                 gain.connect(this.ctx.destination);
                 
                 osc.start(now);
                 osc.stop(now + 1.6);
            }
        };

        const noteValueMap = { 'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11 };
        const valueNoteMap = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B']; 
        
        const midiToNoteNames = { 
            0: ['C', 'B#', 'Dbb'], 
            1: ['Db', 'C#', 'B##'], 
            2: ['D', 'C##', 'Ebb'], 
            3: ['Eb', 'D#', 'Fbb'], 
            4: ['E', 'Fb', 'D##'], 
            5: ['F', 'E#', 'Gbb'], 
            6: ['Gb', 'F#', 'E##'], 
            7: ['G', 'F##', 'Abb'], 
            8: ['Ab', 'G#'], 
            9: ['A', 'G##', 'Bbb'], 
            10: ['Bb', 'A#', 'Cbb'], 
            11: ['B', 'Cb', 'A##'] 
        };
        
        const baseNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const semitoneToInterval = { 0: 'P1/P8', 1: 'm2', 2: 'M2', 3: 'm3', 4: 'M3', 5: 'P4', 6: 'A4/d5', 7: 'P5', 8: 'm6', 9: 'M6', 10: 'm7', 11: 'M7' };
        
        const semitoneToDegree = { 0: '1', 1: 'b2', 2: '2', 3: 'b3', 4: '3', 5: '4', 6: 'b5', 7: '5', 8: 'b6', 9: '6', 10: 'b7', 11: '7' };

        const scaleIntervals = {
            'Major': [0, 2, 4, 5, 7, 9, 11, 12],
            'Natural Minor': [0, 2, 3, 5, 7, 8, 10, 12],
            'Harmonic Minor': [0, 2, 3, 5, 7, 8, 11, 12],
            'Melodic Minor': [0, 2, 3, 5, 7, 9, 11, 12]
        };
        
        const chordOffsetMap = {
            'maj7': [0, 4, 7, 11], 'm7': [0, 3, 7, 10], '7': [0, 4, 7, 10], 'm7(b5)': [0, 3, 6, 10], 
            'dim7': [0, 3, 6, 9], 'mMaj7': [0, 3, 7, 11], 'maj7#5': [0, 4, 8, 11], 
            'I': [0, 4, 7], 'i': [0, 3, 7], 'ii': [0, 3, 7], 'iii': [0, 3, 7], 'IV': [0, 4, 7], 'V': [0, 4, 7], 
            'vi': [0, 3, 7], 'ii°': [0, 3, 6], 'vii°': [0, 3, 6], 'III+': [0, 4, 8], 'v': [0, 3, 7], 'vi°': [0, 3, 6], 'VI': [0, 4, 7], 'VII': [0, 4, 7], 'iv': [0, 3, 7], 'III': [0, 4, 7]
        };
        
        // Manual Chord Recognition Formulas
        const CHORD_FORMULAS = [
            { name: 'Major', intervals: [0, 4, 7] },
            { name: 'Minor', intervals: [0, 3, 7] },
            { name: '5', intervals: [0, 7] },
            { name: 'dim', intervals: [0, 3, 6] },
            { name: 'aug', intervals: [0, 4, 8] },
            { name: 'sus2', intervals: [0, 2, 7] },
            { name: 'sus4', intervals: [0, 5, 7] },
            { name: '7', intervals: [0, 4, 7, 10] },
            { name: 'maj7', intervals: [0, 4, 7, 11] },
            { name: 'm7', intervals: [0, 3, 7, 10] },
            { name: 'mMaj7', intervals: [0, 3, 7, 11] },
            { name: 'dim7', intervals: [0, 3, 6, 9] }, // Full dim
            { name: 'm7b5', intervals: [0, 3, 6, 10] }, // Half dim
            { name: 'add9', intervals: [0, 4, 7, 14] }, // Treated as 2 for simplicity
            { name: 'm(add9)', intervals: [0, 3, 7, 14] }
        ];

        const chordTypes7 = {
            'Major': ['maj7', 'm7', 'm7', 'maj7', '7', 'm7', 'm7(b5)'],
            'Natural Minor': ['m7', 'm7(b5)', 'maj7', 'm7', 'm7', 'maj7', '7'],
            'Harmonic Minor': ['mMaj7', 'm7(b5)', 'maj7#5', 'm7', '7', 'maj7', 'dim7'],
            'Melodic Minor': ['mMaj7', 'm7', 'maj7#5', '7', '7', 'm7(b5)', '7']
        };
        const chordTypes3 = {
            'Major': ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii°'],
            'Natural Minor': ['i', 'ii°', 'III', 'iv', 'v', 'VI', 'VII'],
            'Harmonic Minor': ['i', 'ii°', 'III+', 'iv', 'V', 'vi°', 'vii°'],
            'Melodic Minor': ['i', 'ii', 'III+', 'iv', 'V', 'vi°', 'vii°']
        };

        const modeFunctions = {
            'Major': ['T', 'SD', 'T', 'SD', 'D', 'T', 'D'],
            'Natural Minor': ['T', 'SD', 'T', 'SD', 'D', 'T', 'SD'],
            'Harmonic Minor': ['T', 'SD', 'T', 'SD', 'D', 'SD/T', 'D'],
            'Melodic Minor': ['T', 'SD', 'T', 'SD', 'D', 'SD', 'D']
        };

        const modeRomans = {
            'Major': ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii°'],
            'Natural Minor': ['i', 'ii°', 'III', 'iv', 'v', 'VI', 'VII'],
            'Harmonic Minor': ['i', 'ii°', 'III+', 'iv', 'V', 'vi°', 'vii°'],
            'Melodic Minor': ['i', 'ii', 'III+', 'iv', 'V', 'vi°', 'vii°']
        };

        const modalDataMap = {
            'Major': { names: ['Ionian', 'Dorian', 'Phrygian', 'Lydian', 'Mixolydian', 'Aeolian', 'Locrian'], avoids: [[3], [], [1, 5], [], [3], [5], [1]] },
            'Natural Minor': { names: ['Aeolian', 'Locrian', 'Ionian', 'Dorian', 'Phrygian', 'Lydian', 'Mixolydian'], avoids: [[5], [1], [3], [], [1, 5], [], [3]] },
            'Harmonic Minor': { names: ['Harmonic Minor', 'Locrian nat6', 'Ionian #5', 'Dorian #4', 'Phrygian Dom', 'Lydian #2', 'Altered bb7'], avoids: [[5], [1], [3, 5], [], [1, 3, 5], [], [1, 2]] },
            'Melodic Minor': { names: ['Melodic Minor', 'Dorian b2', 'Lydian Aug', 'Lydian Dom', 'Mixolydian b6', 'Locrian nat2', 'Altered Scale'], avoids: [[], [1], [5], [], [3], [], [1, 3]] }
        };

        let currentView = 'home';
        let history = ['home'];
        let currentMode = 'Major'; 
        let currentKey = 'C'; 
        let selectedNotes = [];
        let isChromatic = false; 
        let chordDegree = 7; 
        let isDark = false;
        let currentLanguage = 'zh';
        let errorCount = 0;
        let correctAnswer = '';
        
        // Guitar state
        let guitarKey = 'C';
        let guitarScaleMode = 'Major'; // Major or Natural Minor or others
        let guitarActiveNotes = new Map(); // Key: StringIdx, Value: {midi, fret, val}
        let isGuitarScrolling = false; // Flag to track drag state

        function toggleTheme() {
            isDark = !isDark;
            document.documentElement.classList.toggle('dark', isDark);
            updateUI();
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            updateUI();
        }

        function cycleLanguage() {
            const order = ['zh', 'en', 'jp'];
            let idx = (order.indexOf(currentLanguage) + 1) % order.length;
            setLanguage(order[idx]);
        }

        function updateKeyVisibility() {
            const keyDisplay = document.getElementById('current-key-display');
            if (currentView === 'chord') {
                keyDisplay.classList.remove('hidden-key');
            } else {
                keyDisplay.classList.add('hidden-key');
            }
        }

        function updateUI() {
            const langData = LANGUAGES[currentLanguage];
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (langData[key]) {
                    if (el.tagName === 'SPAN' || el.children.length === 0) el.textContent = langData[key];
                    else { const span = el.querySelector('span'); if (span) span.textContent = langData[key]; }
                }
            });
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === currentLanguage));
            
            // UI Toggle logic
            document.querySelectorAll('.chord-type-btn').forEach(btn => {
                const degree = parseInt(btn.dataset.degree);
                btn.classList.toggle('active-degree', degree === chordDegree);
            });
            
            // Render Mode Selector if visible
            if (currentView === 'chord') {
                renderModeSelector();
            }

            const mobileSwitcher = document.getElementById('lang-switcher-mobile');
            if (mobileSwitcher) { const labels = { zh: '中', en: 'En', jp: 'JP' }; mobileSwitcher.textContent = labels[currentLanguage]; }
            if (currentView === 'test') {
                const questionArea = document.getElementById('test-question-area');
                if (questionArea && window.lastQuestionData) {
                    const {startNote, name} = window.lastQuestionData;
                    const promptText = LANGUAGES[currentLanguage].quiz_prompt(startNote, name);
                    const currentVal = document.getElementById('ans') ? document.getElementById('ans').value : "";
                    questionArea.innerHTML = `${promptText}<br><br><input type="text" id="ans" class="w-16 border-b-2 border-zinc-200 text-center text-orange-600 outline-none" autocomplete="off" value="${currentVal}">`;
                } else generateTestQuestion();
            }
            document.getElementById('current-key-display').textContent = `Key: ${currentKey}`;
            updateKeyVisibility();
        }

        function calculateInterval(note1, note2) {
            const v1 = noteValueMap[note1] || 0;
            const v2 = noteValueMap[note2] || 0;
            let semitones = (v2 - v1 + 12) % 12; 
            return semitoneToInterval[semitones];
        }

        function getSpelledNote(midiValue, targetLetter) {
            const possibleNames = midiToNoteNames[midiValue] || [];
            return possibleNames.find(name => name.startsWith(targetLetter)) || possibleNames[0] || '?';
        }

        function calculateScale(mode, tonic) {
            const startValue = noteValueMap[tonic];
            const intervals = scaleIntervals[mode];
            const tonicLetterIndex = baseNotes.indexOf(tonic.charAt(0));
            return intervals.slice(0, 7).map((offset, index) => {
                const noteValue = (startValue + offset) % 12;
                const expectedLetter = baseNotes[(tonicLetterIndex + index) % 7];
                return getSpelledNote(noteValue, expectedLetter);
            });
        }

        function goToView(viewId) {
            document.querySelectorAll('.content-area > div').forEach(el => el.classList.add('view-hidden'));
            currentView = viewId;
            document.getElementById(viewId + '-view').classList.remove('view-hidden');
            if (history[history.length - 1] !== viewId) history.push(viewId);
            updateNavButtons();
            if (viewId === 'interval') renderIntervalNotes();
            if (viewId === 'chord') { 
                renderModeSelector();
                renderChordDegrees(); 
            }
            if (viewId === 'guitar') renderGuitarBoard();
            if (viewId === 'test') generateTestQuestion();
            updateKeyVisibility();
            lucide.createIcons();
        }

        function goBack() {
            if (history.length > 1) {
                document.getElementById(currentView + '-view').classList.add('view-hidden');
                history.pop();
                currentView = history[history.length - 1];
                document.getElementById(currentView + '-view').classList.remove('view-hidden');
                updateNavButtons();
                if (currentView === 'chord') {
                    renderModeSelector();
                    renderChordDegrees();
                }
                updateKeyVisibility();
            }
        }

        function updateNavButtons() {
            const backBtn = document.getElementById('back-btn');
            if (history.length > 1 && currentView !== 'home') backBtn.classList.remove('hidden');
            else backBtn.classList.add('hidden');
        }

        function renderIntervalNotes() {
            const container = document.getElementById('note-cycle');
            container.innerHTML = '';
            selectedNotes = [];
            document.getElementById('actual-interval-display').textContent = '';
            const notes = isChromatic ? valueNoteMap : baseNotes;
            notes.forEach(note => {
                const btn = document.createElement('button');
                btn.className = 'note-name w-16 h-16 sm:w-20 sm:h-20 flex items-center justify-center rounded-2xl text-zinc-300 dark:text-zinc-700 font-bold text-3xl sm:text-4xl hover:text-orange-500 cursor-pointer text-center';
                btn.textContent = note;
                btn.onclick = () => {
                    AudioEngine.playChord(note, 'note'); // 点击播放单音
                    if (selectedNotes.length >= 2) return;
                    btn.classList.add('selected-note');
                    selectedNotes.push(note);
                    if (selectedNotes.length === 2) {
                        const res = calculateInterval(selectedNotes[0], selectedNotes[1]);
                        document.getElementById('actual-interval-display').textContent = res;
                        setTimeout(() => { document.querySelectorAll('.note-name').forEach(el => el.classList.remove('selected-note')); selectedNotes = []; }, 1000);
                    }
                };
                container.appendChild(btn);
            });
        }

        function toggleChromatic() { 
            isChromatic = !isChromatic; 
            // Toggle data-key to update text
            const btn = document.getElementById('upgrade-btn');
            const newKey = isChromatic ? 'chromatic_toggle_basic' : 'chromatic_toggle';
            btn.setAttribute('data-lang-key', newKey);
            
            updateUI(); 
            renderIntervalNotes(); 
        }

        function setChordDegree(degree) {
            chordDegree = degree;
            updateUI();
            renderChordDegrees();
        }

        function setKey(newKey) {
            const normalized = newKey.charAt(0).toUpperCase() + (newKey.charAt(1) === '#' || newKey.charAt(1) === 'b' ? newKey.slice(1) : newKey.slice(1).toLowerCase());
            if (noteValueMap[normalized] !== undefined) {
                currentKey = normalized;
                updateUI();
                renderChordDegrees();
            }
        }

        function switchMode(mode) { 
            currentMode = mode; 
            renderModeSelector();
            renderChordDegrees(); 
        }

        function renderModeSelector() {
            const container = document.getElementById('mode-selector');
            if (!container) return;
            container.innerHTML = '';

            const modes = [
                { id: 'Major', langKey: 'major_title' },
                { id: 'Natural Minor', langKey: 'natural_minor_title' },
                { id: 'Harmonic Minor', langKey: 'harmonic_minor_title' },
                { id: 'Melodic Minor', langKey: 'melodic_minor_title' }
            ];

            const langData = LANGUAGES[currentLanguage];

            modes.forEach(mode => {
                const btn = document.createElement('button');
                const isActive = currentMode === mode.id;
                
                // Style: Centered, Gray by default, Black/Bold when active
                let classes = "px-4 py-2 rounded-full text-sm transition-colors whitespace-nowrap flex-shrink-0 ";
                if (isActive) {
                    classes += "text-zinc-900 dark:text-zinc-100 font-bold bg-white dark:bg-zinc-800 shadow-sm";
                } else {
                    classes += "text-zinc-400 hover:text-zinc-600 dark:text-zinc-500 dark:hover:text-zinc-300 font-medium";
                }
                
                btn.className = classes;
                btn.textContent = langData[mode.langKey];
                btn.onclick = () => switchMode(mode.id);
                container.appendChild(btn);
            });
        }

        function getSecondaryDominantInfo(targetNote, targetRoman) {
            const targetRootVal = noteValueMap[targetNote];
            const secRootVal = (targetRootVal + 7) % 12;
            const targetLetter = targetNote.charAt(0);
            const targetLetterIndex = baseNotes.indexOf(targetLetter);
            const secRootLetterIndex = (targetLetterIndex + 4) % 7;
            const secRootLetter = baseNotes[secRootLetterIndex];
            const secRoot = getSpelledNote(secRootVal, secRootLetter);
            const isMinor = targetRoman.toLowerCase() === targetRoman;
            const modal = isMinor ? "Mixolydian ♭9 ♭13" : "Mixolydian";
            const offsets = isMinor ? [0, 1, 4, 5, 7, 8, 10] : [0, 2, 4, 5, 7, 9, 10];
            const chordOffsets = [0, 4, 7, 10];
            const avoidIdxs = [3]; 
            const scaleTones = offsets.map((off, idx) => {
                const val = (secRootVal + off) % 12;
                const letterIdx = (secRootLetterIndex + idx) % 7;
                return getSpelledNote(val, baseNotes[letterIdx]);
            });
            const chordTones = chordOffsets.map((off, idx) => {
                const val = (secRootVal + off) % 12;
                const letterIdx = (secRootLetterIndex + (idx * 2)) % 7;
                return getSpelledNote(val, baseNotes[letterIdx]);
            });
            return { abbr: `V/${targetRoman}`, name: `${secRoot}7`, tones: chordTones, modal: modal, root: secRoot, scaleTones: scaleTones, avoidIdxs: avoidIdxs };
        }
        
        // Helper to reset all other cards view to idle if they are not expanded
        function resetAllCards(exceptCard) {
            document.querySelectorAll('.scale-degree').forEach(card => {
                if (card !== exceptCard && card.resetTempView) {
                    card.resetTempView();
                }
            });
        }

        function renderChordDegrees() {
            const container = document.getElementById('scale-degrees');
            container.innerHTML = '';
            const parentScaleNotes = calculateScale(currentMode, currentKey);
            const romanChords = chordDegree === 7 ? chordTypes7[currentMode] : chordTypes3[currentMode];
            const romans = modeRomans[currentMode];
            const functions = modeFunctions[currentMode];
            const modalData = modalDataMap[currentMode];

            for (let i = 0; i < 7; i++) {
                const root = parentScaleNotes[i];
                const type = romanChords[i];
                const roman = romans[i];
                const func = functions[i];
                const modalName = modalData.names[i];
                const avoidIdxs = modalData.avoids[i];
                const modalScale = [];
                for (let j = 0; j < 7; j++) modalScale.push(parentScaleNotes[(i + j) % 7]);
                const chordTones = chordDegree === 7 ? [modalScale[0], modalScale[2], modalScale[4], modalScale[6]] : [modalScale[0], modalScale[2], modalScale[4]];

                const cardOuter = document.createElement('div');
                cardOuter.className = 'group relative scale-degree border border-zinc-200 dark:border-zinc-800 rounded-3xl bg-white dark:bg-zinc-900 shadow-sm transition-all overflow-hidden select-none h-56';
                
                // CRITICAL: Prevent default browser vertical scroll stealing horizontal swipes
                cardOuter.style.touchAction = 'pan-y';

                const cardInner = document.createElement('div');
                cardInner.className = 'chord-card-inner';

                let isExp = false;
                let isSecExp = false;

                // Helper to reset this card's temporary tone display (single click state)
                cardOuter.resetTempView = () => {
                   if (!isExp && !isSecExp) {
                       updatePrimaryDisplay('idle');
                       updateSecondaryDisplay('idle');
                   }
                };

                // Touch Swipe Support
                let touchStartX = 0;
                let touchStartY = 0;
                let lastTap = 0; // For double tap detection

                cardOuter.ontouchstart = (e) => { 
                    touchStartX = e.touches[0].clientX; 
                    touchStartY = e.touches[0].clientY; 
                };
                
                cardOuter.ontouchend = (e) => {
                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTap;
                    const deltaX = e.changedTouches[0].clientX - touchStartX;
                    const deltaY = e.changedTouches[0].clientY - touchStartY;
                    
                    // Double Tap Detection Logic for Mobile (when movement is small)
                    if (tapLength < 300 && tapLength > 0 && Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10) {
                        e.preventDefault();
                        if (cardOuter.classList.contains('is-secondary')) {
                            // Secondary face double tap
                            isSecExp = !isSecExp; 
                            cardOuter.classList.toggle('chord-card-active', isSecExp); 
                            updateSecondaryDisplay(isSecExp ? 'scale' : 'chord');
                        } else {
                            // Primary face double tap
                            isExp = !isExp; 
                            cardOuter.classList.toggle('chord-card-active', isExp); 
                            updatePrimaryDisplay(isExp ? 'scale' : 'chord');
                        }
                    }
                    lastTap = currentTime;

                    // Swipe Logic
                    // 1. Threshold > 60px
                    // 2. Ratio > 3 (Horizontal vs Vertical)
                    if (Math.abs(deltaX) > 60 && Math.abs(deltaX) > Math.abs(deltaY) * 3) {
                        if (deltaX > 0) {
                            // Swipe Right: Show Secondary
                            cardOuter.classList.add('is-secondary');
                        } else {
                            // Swipe Left: Show Primary
                            cardOuter.classList.remove('is-secondary');
                        }
                        // Reset expansion on swipe
                        cardOuter.classList.remove('chord-card-active');
                        isExp = false;
                        isSecExp = false;
                        updatePrimaryDisplay('idle');
                        updateSecondaryDisplay('idle');
                    }
                };

                // --- SECONDARY FACE (Back) ---
                const secondaryFace = document.createElement('div');
                // 使用 secondary-face 类名控制背景过渡
                secondaryFace.className = 'chord-card-face secondary-face py-6 px-2 relative transition-colors duration-500';
                
                const sec = getSecondaryDominantInfo(root, roman);
                const secAbbr = document.createElement('div');
                secAbbr.className = 'text-[9px] font-bold text-zinc-400 dark:text-zinc-500 uppercase tracking-widest mb-6 text-center flex gap-1 items-center justify-center';
                // Change SD to Sec D
                secAbbr.innerHTML = `<span>${sec.abbr}</span> <span class="opacity-30">|</span> <span>Sec D</span>`;

                const secRootDisplay = document.createElement('div');
                secRootDisplay.className = 'sec-root-display text-4xl font-bold text-zinc-700 dark:text-zinc-300 transition-colors text-center';
                secRootDisplay.textContent = sec.root;

                const secModalWrapper = document.createElement('div');
                secModalWrapper.className = 'modal-name-wrapper flex items-center justify-center text-center px-2';
                secModalWrapper.innerHTML = `<span class="text-[10px] sm:text-xs font-bold text-orange-500 dark:text-orange-400 uppercase tracking-tight leading-tight">${sec.modal}</span>`;

                const secNameDisplay = document.createElement('div');
                secNameDisplay.className = 'text-xs font-semibold text-zinc-400 dark:text-zinc-500 h-5 flex items-center justify-center text-center mt-6';
                secNameDisplay.textContent = sec.name;

                const secTonesArea = document.createElement('div');
                // Updated class: removed h-5, added h-auto and py-1 to allow multi-line items (note + degree)
                secTonesArea.className = 'view-hidden flex flex-nowrap gap-x-0 justify-center h-auto w-full tracking-tighter whitespace-nowrap overflow-hidden px-1 mt-6';

                const updateSecondaryDisplay = (state) => {
                    secTonesArea.innerHTML = '';
                    if (state === 'idle') { secNameDisplay.classList.remove('view-hidden'); secTonesArea.classList.add('view-hidden'); }
                    else {
                        secNameDisplay.classList.add('view-hidden'); secTonesArea.classList.remove('view-hidden');
                        const list = state === 'chord' ? sec.tones : sec.scaleTones;
                        // For degrees, we always calculate relative to the current card's secondary root
                        const currentRoot = sec.root;
                        
                        list.forEach((t, idx) => {
                            // Calculate degree relative to root
                            const v1 = noteValueMap[currentRoot];
                            const v2 = noteValueMap[t];
                            const semi = (v2 - v1 + 12) % 12;
                            const degree = semitoneToDegree[semi];

                            // Container for vertical stacking
                            const col = document.createElement('div');
                            col.className = 'flex flex-col items-center justify-start w-6 sm:w-8';

                            const s = document.createElement('span');
                            if (state === 'chord') s.className = 'text-xs font-semibold text-orange-500 note-item';
                            else {
                                const isCT = sec.tones.includes(t); 
                                const isAv = sec.avoidIdxs.includes(idx);
                                if (isCT) s.className = 'text-xs text-orange-500 font-semibold note-item';
                                else if (isAv) s.className = 'text-xs text-zinc-400 font-semibold note-item line-through decoration-1';
                                else s.className = 'text-xs text-zinc-900 dark:text-zinc-100 font-semibold note-item';
                            }
                            s.textContent = t;
                            col.appendChild(s);

                            // Add degree below if in expanded scale mode (or even chord mode if preferred, but usually scale needs it more)
                            // "In the expanded..." usually refers to the double-click state which shows the scale.
                            if (state === 'scale') {
                                const d = document.createElement('span');
                                d.className = 'text-[10px] text-zinc-400 font-normal mt-1 note-item';
                                d.textContent = degree;
                                col.appendChild(d);
                            }

                            secTonesArea.appendChild(col);
                        });
                    }
                };

                const arrowRightToPri = document.createElement('div');
                arrowRightToPri.className = 'edge-trigger edge-right';
                arrowRightToPri.innerHTML = '<i data-lucide="chevron-right" class="w-6 h-6"></i>';
                arrowRightToPri.onclick = (e) => { 
                    e.stopPropagation(); 
                    cardOuter.classList.remove('is-secondary');
                    cardOuter.classList.remove('chord-card-active');
                    isExp = false;
                    isSecExp = false;
                    updatePrimaryDisplay('idle');
                    updateSecondaryDisplay('idle');
                };

                secondaryFace.onclick = (e) => { 
                    e.stopPropagation(); // Stop propagation to allow global click listener to ignore this click
                    resetAllCards(cardOuter); // Reset other cards
                    AudioEngine.playChord(sec.root, '7'); 
                    if(!isSecExp) updateSecondaryDisplay('chord'); 
                };
                // Desktop Double Click retained
                secondaryFace.ondblclick = () => { isSecExp = !isSecExp; cardOuter.classList.toggle('chord-card-active', isSecExp); updateSecondaryDisplay(isSecExp ? 'scale' : 'chord'); };
                
                // Long Press (retained as backup)
                let secPressTimer;
                secondaryFace.onmousedown = secondaryFace.ontouchstart = (e) => {
                    if (e.type === 'touchstart') {
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                    }
                    secPressTimer = window.setTimeout(() => { 
                        // Only trigger if no movement (prevent conflict with swipe)
                        isSecExp = !isSecExp; cardOuter.classList.toggle('chord-card-active', isSecExp); updateSecondaryDisplay(isSecExp ? 'scale' : 'chord');
                    }, 600); // Increased slightly to avoid conflict with double tap
                }
                secondaryFace.onmouseup = secondaryFace.onmouseleave = secondaryFace.ontouchend = () => { window.clearTimeout(secPressTimer); };

                secondaryFace.appendChild(arrowRightToPri); secondaryFace.appendChild(secAbbr); secondaryFace.appendChild(secRootDisplay); secondaryFace.appendChild(secModalWrapper); secondaryFace.appendChild(secNameDisplay); secondaryFace.appendChild(secTonesArea);

                // --- PRIMARY FACE (Front) ---
                const primaryFace = document.createElement('div');
                primaryFace.className = 'chord-card-face py-6 px-2 text-center bg-white dark:bg-zinc-900';
                
                const header = document.createElement('div');
                header.className = 'text-[9px] font-bold text-zinc-400 dark:text-zinc-500 uppercase tracking-widest flex gap-1 items-center justify-center mb-6 text-center';
                header.innerHTML = `<span>${roman}</span> <span class="opacity-30">|</span> <span>${func}</span>`;
                
                const rootDisplay = document.createElement('div');
                rootDisplay.className = 'root-display text-4xl font-bold text-zinc-700 dark:text-zinc-300 transition-all cursor-pointer text-center';
                rootDisplay.textContent = root;
                rootDisplay.onclick = (e) => {
                    e.stopPropagation();
                    setTimeout(() => {
                        const next = prompt(`Change ${roman} (${root}) to?`, root);
                        if (next) {
                            // Reverse Calculate Key Logic
                            const normalizedNext = next.charAt(0).toUpperCase() + (next.charAt(1) === '#' || next.charAt(1) === 'b' ? next.slice(1) : next.slice(1).toLowerCase());
                            const nextVal = noteValueMap[normalizedNext];
                            
                            if (nextVal !== undefined) {
                                // 1. Get current interval offset for this degree
                                const currentScaleIntervals = scaleIntervals[currentMode];
                                const degreeOffset = currentScaleIntervals[i]; // 'i' is the loop index, which is the degree index (0-6)
                                
                                // 2. Calculate New Tonic Value
                                // NewTonic = (NewDegreeVal - DegreeOffset)
                                let newTonicVal = (nextVal - degreeOffset) % 12;
                                if (newTonicVal < 0) newTonicVal += 12;

                                // 3. Find the best note name for this value
                                // We pick the first one from midiToNoteNames, or try to be smart (e.g. C over B#, F over E#)
                                // Standard map usually puts common name first: 0->C, 1->Db/C#
                                // Simplification: Just pick the first available name for now.
                                const possibleTonics = midiToNoteNames[newTonicVal];
                                const newKey = possibleTonics[0]; // e.g. 'C', 'Db', 'D'...

                                setKey(newKey);
                            }
                        }
                    }, 50);
                };

                const modalWrapper = document.createElement('div');
                modalWrapper.className = 'modal-name-wrapper flex items-center justify-center text-center px-2';
                modalWrapper.innerHTML = `<span class="text-[10px] sm:text-xs font-bold text-orange-500 dark:text-orange-400 uppercase tracking-tight leading-tight">${modalName}</span>`;

                const nameDisplay = document.createElement('div');
                nameDisplay.className = 'text-xs font-semibold text-zinc-400 dark:text-zinc-500 h-5 flex items-center justify-center text-center mt-6';
                nameDisplay.textContent = `${root}${type}`;
                const tonesArea = document.createElement('div');
                // Updated class: removed h-5, added h-auto
                tonesArea.className = 'view-hidden flex flex-nowrap gap-x-0 justify-center h-auto w-full tracking-tighter whitespace-nowrap overflow-hidden px-1 mt-6';
                
                const updatePrimaryDisplay = (state) => {
                    tonesArea.innerHTML = '';
                    if (state === 'idle') { nameDisplay.classList.remove('view-hidden'); tonesArea.classList.add('view-hidden'); }
                    else {
                        nameDisplay.classList.add('view-hidden'); tonesArea.classList.remove('view-hidden');
                        const list = state === 'chord' ? chordTones : modalScale;
                        const currentRoot = root; // Use card root for primary face

                        list.forEach((t, idx) => {
                            // Calculate degree relative to root
                            const v1 = noteValueMap[currentRoot];
                            const v2 = noteValueMap[t];
                            const semi = (v2 - v1 + 12) % 12;
                            const degree = semitoneToDegree[semi];

                            // Container
                            const col = document.createElement('div');
                            col.className = 'flex flex-col items-center justify-start w-6 sm:w-8';

                            const s = document.createElement('span');
                            if (state === 'chord') s.className = 'text-xs font-semibold text-orange-500 note-item';
                            else {
                                const isCT = chordTones.includes(t); const isAv = avoidIdxs.includes(idx);
                                if (isCT) s.className = 'text-xs text-orange-500 font-semibold note-item';
                                else if (isAv) s.className = 'text-xs text-zinc-400 font-semibold note-item line-through decoration-1';
                                else s.className = 'text-xs text-zinc-900 dark:text-zinc-100 font-semibold note-item';
                            }
                            s.textContent = t;
                            col.appendChild(s);

                             // Add degree below if in expanded scale mode
                            if (state === 'scale') {
                                const d = document.createElement('span');
                                d.className = 'text-[10px] text-zinc-400 font-normal mt-1 note-item';
                                d.textContent = degree;
                                col.appendChild(d);
                            }

                            tonesArea.appendChild(col);
                        });
                    }
                };

                const arrowLeftToSec = document.createElement('div');
                arrowLeftToSec.className = 'edge-trigger edge-left';
                arrowLeftToSec.innerHTML = '<i data-lucide="chevron-left" class="w-6 h-6"></i>';
                arrowLeftToSec.onclick = (e) => { 
                    e.stopPropagation(); 
                    cardOuter.classList.add('is-secondary');
                    cardOuter.classList.remove('chord-card-active');
                    isExp = false;
                    isSecExp = false;
                    updatePrimaryDisplay('idle');
                    updateSecondaryDisplay('idle');
                };

                primaryFace.onclick = (e) => { 
                    e.stopPropagation();
                    resetAllCards(cardOuter); // Reset other cards
                    AudioEngine.playChord(root, type); 
                    if(!isExp) updatePrimaryDisplay('chord'); 
                };
                primaryFace.ondblclick = () => { isExp = !isExp; cardOuter.classList.toggle('chord-card-active', isExp); updatePrimaryDisplay(isExp ? 'scale' : 'chord'); };
                
                let priPressTimer;
                primaryFace.onmousedown = primaryFace.ontouchstart = (e) => {
                    if (e.type === 'touchstart') {
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                    }
                    priPressTimer = window.setTimeout(() => { 
                        isExp = !isExp; cardOuter.classList.toggle('chord-card-active', isExp); updatePrimaryDisplay(isExp ? 'scale' : 'chord');
                    }, 600);
                }
                primaryFace.onmouseup = primaryFace.onmouseleave = primaryFace.ontouchend = () => { window.clearTimeout(priPressTimer); };

                primaryFace.appendChild(arrowLeftToSec); primaryFace.appendChild(header); primaryFace.appendChild(rootDisplay); primaryFace.appendChild(modalWrapper); primaryFace.appendChild(nameDisplay); primaryFace.appendChild(tonesArea);
                cardInner.appendChild(secondaryFace); cardInner.appendChild(primaryFace); cardOuter.appendChild(cardInner); container.appendChild(cardOuter);
            }
            lucide.createIcons();
        }

        // Global click listener to reset card states
        document.addEventListener('click', (e) => {
            // Check if the click is NOT inside a scale-degree card
            if (!e.target.closest('.scale-degree')) {
                resetAllCards(null); // Reset all cards
            }
        });

        function generateTestQuestion() {
            errorCount = 0; const startNote = baseNotes[Math.floor(Math.random() * 7)];
            const intervals = Object.entries(semitoneToInterval); const [semi, name] = intervals[Math.floor(Math.random() * intervals.length)];
            correctAnswer = valueNoteMap[(noteValueMap[startNote] + parseInt(semi)) % 12];
            window.lastQuestionData = {startNote, name};
            const promptText = LANGUAGES[currentLanguage].quiz_prompt(startNote, name);
            document.getElementById('test-question-area').innerHTML = `${promptText}<br><br><input type="text" id="ans" class="w-16 border-b-2 border-zinc-200 text-center text-orange-600 outline-none" autocomplete="off">`;
            document.getElementById('feedback-message').textContent = '';
        }

        function checkAnswer() {
            const inputEl = document.getElementById('ans'); const val = inputEl.value.trim().toUpperCase();
            const feedbackEl = document.getElementById('feedback-message'); const lang = LANGUAGES[currentLanguage];
            if (val === correctAnswer.toUpperCase()) {
                feedbackEl.textContent = lang.feedback_correct; feedbackEl.className = "h-8 text-center font-bold text-sm mb-8 tracking-wide text-green-500";
                setTimeout(generateTestQuestion, 1000);
            } else {
                errorCount++;
                if (errorCount >= 3) { feedbackEl.textContent = lang.feedback_reveal + correctAnswer; feedbackEl.className = "h-8 text-center font-bold text-sm mb-8 tracking-wide text-orange-500"; }
                else { feedbackEl.textContent = lang.feedback_wrong; feedbackEl.className = "h-8 text-center font-bold text-sm mb-8 tracking-wide text-red-500"; }
            }
        }
        
        // --- GUITAR FUNCTIONALITY ---
        function updateGuitarKey(val) {
             const keyInput = val.trim();
             // Regex to identify Key and Mode (e.g. C, Am, F#m, Bb)
             const match = keyInput.match(/^([A-Ga-g][#b]?)(m?)$/i);
             
             if (match) {
                 // match[1] is note (c, C, c#, C#)
                 // match[2] is 'm' if minor
                 
                 let notePart = match[1];
                 // Normalize note: first letter upper, second lower
                 notePart = notePart.charAt(0).toUpperCase() + (notePart.length > 1 ? notePart.charAt(1).toLowerCase() : '');
                 
                 // Check if valid note in our map
                 if (noteValueMap[notePart] === undefined) return;

                 const isMinor = match[2].toLowerCase() === 'm';
                 
                 guitarKey = notePart;
                 
                 // Smart select mode based on input
                 const modeSelect = document.getElementById('guitar-mode-select');
                 if (isMinor) {
                    // Only switch if currently Major, otherwise keep specific minor mode (Harmonic/Melodic)
                    if (guitarScaleMode === 'Major') {
                         guitarScaleMode = 'Natural Minor';
                         if(modeSelect) modeSelect.value = 'Natural Minor';
                    }
                 } else {
                    guitarScaleMode = 'Major';
                    if(modeSelect) modeSelect.value = 'Major';
                 }
                 
                 // Update Display (keep input clean)
                 // document.getElementById('guitar-key-input').value = guitarKey + (isMinor ? 'm' : '');
                 
                 // Clear board when key changes
                 clearGuitarBoard(true);
             }
        }

        function updateGuitarScaleMode(val) {
            guitarScaleMode = val;
            clearGuitarBoard(true); // Clear board to avoid confusion
        }
        
        function isDiatonicChord(rootName, suffix) {
             const keyScale = calculateScale(guitarScaleMode, guitarKey);
             const degreeIndex = keyScale.indexOf(rootName);
             if (degreeIndex === -1) return false;
             
             // Check if suffix matches known diatonic type
             const expectedSuffix = chordTypes7[guitarScaleMode][degreeIndex]; // Get 7th type
             if (suffix === expectedSuffix) return true;
             
             // Also check triads if needed, but 'detectChord' usually returns simplified names or based on formulas.
             // For strict Diatonic matching, exact match is safest.
             // Note: detectChord returns things like 'm7' or 'Major'. 
             // Convert 'Major' to empty string for comparison? No, detectChord returns 'C' for major triad.
             // For simplicity in this app: If root is in scale, we consider it orange "in-key" for now to reduce confusion,
             // OR verify strictly. The user asked "is in key chord use orange".
             
             return true; 
        }

        // Manual Chord Detection Logic
        function detectChord(activeNotesMap) {
            const notes = Array.from(activeNotesMap.values());
            if (notes.length < 3) return null; // Need at least 3 notes for a chord
            
            // Get unique pitch classes (0-11)
            const pitchClasses = [...new Set(notes.map(n => n.val))].sort((a, b) => a - b);
            
            if (pitchClasses.length < 3) return null;

            // Brute force check: Treat each note as potential root
            for (let i = 0; i < pitchClasses.length; i++) {
                const root = pitchClasses[i];
                
                // Calculate intervals relative to this root
                const currentIntervals = pitchClasses.map(p => (p - root + 12) % 12).sort((a, b) => a - b);
                
                // Compare with known formulas
                for (let f = 0; f < CHORD_FORMULAS.length; f++) {
                    const formula = CHORD_FORMULAS[f];
                    const targetIntervals = formula.intervals;
                    
                    // Check if currentIntervals contains all targetIntervals (allowing for extra notes like adds if formula is exact, or subset)
                    // Strict match for basic triads/7ths for now
                    if (targetIntervals.length === currentIntervals.length && 
                        targetIntervals.every((val, index) => val === currentIntervals[index])) {
                        
                        const rootName = midiToNoteNames[root][0];
                        return { rootName, suffix: formula.name === 'Major' ? '' : formula.name, fullName: `${rootName}${formula.name === 'Major' ? '' : formula.name}` };
                    }
                }
            }
            return null; // Unknown chord
        }

        function initGuitarScroll() {
            const slider = document.querySelector('.guitar-scroll-container');
            if (!slider) return;
            let isDown = false;
            let startX;
            let scrollLeft;

            slider.addEventListener('mousedown', (e) => {
                isDown = true;
                isGuitarScrolling = false; // Reset status on new press
                slider.classList.add('active'); // Optional for styling
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });

            slider.addEventListener('mouseleave', () => {
                isDown = false;
                slider.classList.remove('active');
            });

            slider.addEventListener('mouseup', () => {
                isDown = false;
                slider.classList.remove('active');
                // Small delay to ensure click events fire correctly if not scrolling
                setTimeout(() => { isGuitarScrolling = false; }, 50); 
            });

            slider.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2; // Scroll-fast multiplier
                
                // Only mark as scrolling if moved significantly
                if (Math.abs(walk) > 5) {
                    isGuitarScrolling = true;
                }
                
                slider.scrollLeft = scrollLeft - walk;
            });
        }

        function renderGuitarBoard() {
            const container = document.getElementById('fretboard');
            if (!container) return;
            container.innerHTML = '';

            // Configuration
            const stringTunings = [64, 59, 55, 50, 45, 40]; // High E (E4) to Low E (E2)
            const fretCount = 15; // 0 (Nut) to 14
            
            // Generate visual rows for 6 strings
            for (let s = 0; s < 6; s++) {
                const stringRow = document.createElement('div');
                stringRow.className = 'flex h-12 w-full relative select-none';
                
                // The visual string line
                const stringLine = document.createElement('div');
                stringLine.className = `guitar-string str-${s}`;
                stringRow.appendChild(stringLine);
                
                // Generate fret cells
                let remainingLength = 1200; // Arbitrary scale length for visual calc
                
                for (let f = 0; f <= fretCount; f++) {
                    const cell = document.createElement('div');
                    cell.className = `fret-cell fret-${f}`;
                    
                    // Calculate visual width to simulate perspective
                    let width;
                    if (f === 0) {
                        width = 40; // Fixed nut width
                    } else {
                        // Standard formula approximation: Width = PreviousLength / 17.817
                        width = remainingLength / 16; 
                        remainingLength -= width;
                    }
                    if (width < 45) width = 45; 
                    
                    cell.style.width = `${width}px`;
                    
                    // Interaction
                    const midi = stringTunings[s] + f;
                    const noteName = midiToNoteNames[midi % 12][0];
                    
                    // --- Interaction Handlers (Click + Long Press) ---
                    let pressTimer;
                    let isLongPress = false;
                    let startX, startY;

                    const toggleNote = () => {
                         // Check if this specific note is already active
                         const currentActive = guitarActiveNotes.get(s);
                         
                         // Clear previous visual on this string
                         const row = container.children[s];
                         // Clean all cells in this row
                         for(let i=0; i<row.children.length; i++) {
                             if(row.children[i].classList.contains('fret-cell')) {
                                 row.children[i].innerHTML = '';
                             }
                         }

                         // Logic: If clicking same note, remove it. If different, replace it.
                         if (currentActive && currentActive.fret === f) {
                             guitarActiveNotes.delete(s);
                             // Just removed, no sound? Or maybe mute sound.
                         } else {
                             // Add new note
                             guitarActiveNotes.set(s, { midi: midi, fret: f, val: midi % 12 });
                             
                             // Render Marker
                             const marker = document.createElement('div');
                             marker.className = 'guitar-note-marker marker-root';
                             marker.textContent = noteName;
                             cell.appendChild(marker);
                             
                             // Vibrate & Play
                             stringLine.classList.remove('string-vibrating');
                             void stringLine.offsetWidth; 
                             stringLine.classList.add('string-vibrating');
                             AudioEngine.playGuitarNote(midi);
                         }

                         // Detect Chord from all active notes
                         const detected = detectChord(guitarActiveNotes);
                         const chordDisplay = document.getElementById('guitar-chord-name');
                         
                         if (detected) {
                             chordDisplay.textContent = detected.fullName;
                             // Check if diatonic to color Orange, else Gray
                             const isDia = isDiatonicChord(detected.rootName, detected.suffix);
                             if (isDia) {
                                 chordDisplay.className = "text-xl font-black text-orange-500 truncate";
                             } else {
                                 chordDisplay.className = "text-xl font-black text-zinc-400 truncate";
                             }
                         } else if (guitarActiveNotes.size > 0) {
                             chordDisplay.textContent = "...";
                             chordDisplay.className = "text-xl font-black text-zinc-300 truncate";
                         } else {
                             chordDisplay.textContent = "";
                         }
                    };

                    const handleChordContext = () => {
                         // Long Press Action: Deduce Chord. Pass the STRING INDEX 's'.
                         playGuitarChordContext(midi, noteName, f, s);
                    };

                    const startAction = (e) => {
                         if (e.type === 'touchstart') {
                             startX = e.touches[0].clientX;
                             startY = e.touches[0].clientY;
                         }
                         isLongPress = false;
                         pressTimer = setTimeout(() => {
                             // Only trigger long press if we didn't scroll
                             if (!isGuitarScrolling) {
                                isLongPress = true;
                                handleChordContext();
                             }
                         }, 600); // 600ms long press
                    };

                    const endAction = (e) => {
                        clearTimeout(pressTimer);
                        // If it was a drag-scroll action, do NOT toggle note
                        if (isGuitarScrolling) return;

                        if (!isLongPress) {
                             // Regular Click: Toggle Note
                             toggleNote();
                        }
                    };

                    const moveAction = (e) => {
                         if (e.type === 'touchmove') {
                             if (Math.abs(e.touches[0].clientX - startX) > 10 || Math.abs(e.touches[0].clientY - startY) > 10) {
                                 clearTimeout(pressTimer); 
                                 isLongPress = true; // Cancel click on scroll
                             }
                         }
                    };
                    
                    cell.addEventListener('mousedown', startAction);
                    cell.addEventListener('mouseup', endAction);
                    cell.addEventListener('touchstart', startAction, {passive: true});
                    cell.addEventListener('touchend', endAction);
                    cell.addEventListener('touchmove', moveAction, {passive: true});
                    
                    // Double Click Feature
                    cell.addEventListener('dblclick', (e) => {
                        e.preventDefault();
                        handleChordContext();
                    });

                    stringRow.appendChild(cell);
                }
                
                container.appendChild(stringRow);
            }
            
            // Fret Numbers Row
            const numRow = document.createElement('div');
            numRow.className = 'flex h-8 w-full';
            let remLenNum = 1200;
            for (let f = 0; f <= fretCount; f++) {
                const cell = document.createElement('div');
                cell.className = 'flex-shrink-0 text-center flex justify-center';
                 let width;
                    if (f === 0) {
                        width = 40; 
                    } else {
                        width = remLenNum / 16; 
                        remLenNum -= width;
                    }
                if (width < 45) width = 45;
                cell.style.width = `${width}px`;
                
                if ([3, 5, 7, 9, 12].includes(f)) {
                    const num = document.createElement('div');
                    num.className = 'fret-number';
                    num.textContent = f;
                    cell.appendChild(num);
                }
                numRow.appendChild(cell);
            }
            container.appendChild(numRow);
        }
        
        // Show chord tones on fretboard
        function playGuitarChordContext(rootMidi, rootName, rootFret, rootStringIdx) {
            clearGuitarBoard(false); // Clear visuals but manage state carefully below

            // 1. Key Check
            const keyScale = calculateScale(guitarScaleMode, guitarKey);
            const normalize = (n) => noteValueMap[n];
            const scaleIndices = keyScale.map(n => normalize(n));
            const rootIndex = normalize(rootName);
            const degreeIndex = scaleIndices.indexOf(rootIndex);

            // 2. Render Anchor Note (Clicked)
            const anchorContainer = document.getElementById('fretboard');
            if (degreeIndex === -1) {
                // Not in key, render GRAY root and return
                 if(anchorContainer && anchorContainer.children[rootStringIdx]) {
                    const cell = anchorContainer.children[rootStringIdx].children[rootFret+1];
                    cell.innerHTML = '';
                    const m = document.createElement('div');
                    m.className = 'guitar-note-marker marker-gray'; 
                    m.textContent = rootName;
                    cell.appendChild(m);
                    AudioEngine.playGuitarNote(rootMidi);
                    // Update Active State
                    guitarActiveNotes.set(rootStringIdx, { midi: rootMidi, fret: rootFret, val: rootMidi % 12 });
                    
                    // Display name as note but gray
                    const chordDisplay = document.getElementById('guitar-chord-name');
                    chordDisplay.textContent = rootName;
                    chordDisplay.className = "text-xl font-black text-zinc-400 truncate";
                 }
                return;
            }

            // 3. Chord Info
            const chordType = chordTypes7[guitarScaleMode][degreeIndex];
            const chordName = rootName + chordType;
            const chordDisplay = document.getElementById('guitar-chord-name');
            chordDisplay.textContent = chordName;
            // Force Orange Always for Diatonic Generated Chords
            chordDisplay.className = "text-xl font-black text-orange-500 truncate";

            const offsets = chordOffsetMap[chordType];
            const rootVal = noteValueMap[rootName];
            const chordToneVals = offsets.map(o => (rootVal + o) % 12);
            // Indices: 0=Root, 1=3rd, 2=5th, 3=7th

            // 4. Candidate Collection
            const minFret = Math.max(0, rootFret - 3);
            const maxFret = Math.min(15, rootFret + 4); 
            const stringTunings = [64, 59, 55, 50, 45, 40];

            let candidates = [];
            
            for (let s = 0; s < 6; s++) {
                if (s === rootStringIdx) continue; // Skip anchor string

                const openMidi = stringTunings[s];
                for (let f = minFret; f <= maxFret; f++) {
                    const m = openMidi + f;
                    const val = m % 12;
                    const toneIdx = chordToneVals.indexOf(val);
                    
                    if (toneIdx !== -1) {
                        candidates.push({
                            sIdx: s,
                            fret: f,
                            midi: m,
                            val: val,
                            toneIdx: toneIdx, // 0,1,2,3
                            dist: Math.abs(f - rootFret)
                        });
                    }
                }
            }

            // 5. Selection Logic
            const selectedNotes = []; 
            const coveredTones = new Set([rootVal]);
            const occupiedStrings = new Set([rootStringIdx]);
            
            // Add anchor to selected for rendering later
            selectedNotes.push({
                sIdx: rootStringIdx, fret: rootFret, midi: rootMidi, val: rootVal, toneIdx: 0, isAnchor: true
            });

            // Helper to pick best candidate
            const pick = (filterFn) => {
                const available = candidates.filter(c => 
                    !occupiedStrings.has(c.sIdx) && filterFn(c)
                );
                if (available.length === 0) return false;
                
                // Sort by Distance ASC
                available.sort((a,b) => a.dist - b.dist);
                
                const choice = available[0];
                selectedNotes.push(choice);
                occupiedStrings.add(choice.sIdx);
                coveredTones.add(choice.val);
                return true;
            };

            // Pass 1: Missing Essentials (3rd: idx 1, 7th: idx 3)
            // We loop specifically to find 3rd then 7th
            [1, 3].forEach(targetIdx => {
                 if (chordToneVals[targetIdx] !== undefined && !coveredTones.has(chordToneVals[targetIdx])) {
                     pick(c => c.toneIdx === targetIdx);
                 }
            });

            // Pass 2: Root (idx 0) if missing
            if (!coveredTones.has(chordToneVals[0])) {
                pick(c => c.toneIdx === 0);
            }

            // Pass 3: 5th (idx 2) if missing
            if (chordToneVals[2] !== undefined && !coveredTones.has(chordToneVals[2])) {
                pick(c => c.toneIdx === 2);
            }
            
            // Pass 4: Fill remaining strings with closest valid notes
            while(occupiedStrings.size < 6) {
                 const success = pick(c => true); 
                 if (!success) break;
            }

            // 6. Rendering & State Update
            guitarActiveNotes.clear(); // Reset manual state to match generated chord
            let playedCount = 0;
            
            const notesByString = new Array(6).fill(null);
            selectedNotes.forEach(n => notesByString[n.sIdx] = n);

            for (let s = 0; s < 6; s++) {
                const note = notesByString[s];
                if (note) {
                     // Sync State
                     guitarActiveNotes.set(s, { midi: note.midi, fret: note.fret, val: note.val });
                     
                     const row = anchorContainer.children[s];
                     const cell = row.children[note.fret + 1];
                     const nName = midiToNoteNames[note.midi % 12][0];
                     
                     cell.innerHTML = '';
                     const marker = document.createElement('div');
                     
                     // Style logic: Root gets orange background, others white
                     const isRoot = (note.val === rootVal);
                     marker.className = `guitar-note-marker ${isRoot ? 'marker-root' : 'marker-tone'}`;
                     marker.textContent = nName;
                     cell.appendChild(marker);
                     
                     // Play Audio Staggered
                     setTimeout(() => {
                        const line = row.querySelector('.guitar-string');
                        line.classList.remove('string-vibrating');
                        void line.offsetWidth;
                        line.classList.add('string-vibrating');
                        AudioEngine.playGuitarNote(note.midi);
                     }, playedCount * 40); // Faster strum
                     playedCount++;
                }
            }
        }

        function clearGuitarBoard(clearState = true) {
             document.querySelectorAll('.guitar-note-marker').forEach(el => el.remove());
             document.getElementById('guitar-chord-name').textContent = '';
             if(clearState) guitarActiveNotes.clear();
        }

        window.onload = () => { 
            goToView('home'); 
            updateUI();
            initGuitarScroll(); // Initialize the drag scroll
        };
    </script>
</body>
</html>

